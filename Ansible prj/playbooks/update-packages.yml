---
- name: Aktualizacja pakietów na hostach Debian/Ubuntu
  hosts: webservers
  become: true
  gather_facts: true

  vars:
    autoremove: true

  tasks:
    - name: Aktualizacja cache pakietów APT
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Uaktualnienie wszystkich pakietów
      ansible.builtin.apt:
        upgrade: dist

    - name: Usunięcie zbędnych pakietów
      ansible.builtin.apt:
        autoremove: "{{ autoremove }}"
        purge: false
      when: autoremove

    - name: Sprawdzenie czy wymagany jest restart systemu
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Restart systemu jeśli wymagany
      ansible.builtin.reboot:
        msg: "Restart po aktualizacji pakietów"
        reboot_timeout: 900
      when: reboot_required.stat.exists | default(false)
